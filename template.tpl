___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Reelevant Website Tracking Tag",
  "categories": [
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Track user\u0027s behavior and use it in Reelevant.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "eventConfiguration",
    "displayName": "Event configuration",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "eventName",
        "displayName": "Event",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "boot",
            "displayValue": "Startup"
          },
          {
            "value": "identify",
            "displayValue": "User identification"
          },
          {
            "value": "page_view",
            "displayValue": "Page view"
          },
          {
            "value": "product_page",
            "displayValue": "Product page view"
          },
          {
            "value": "add_cart",
            "displayValue": "Add item to cart"
          },
          {
            "value": "purchase",
            "displayValue": "Purchase items"
          },
          {
            "value": "category_view",
            "displayValue": "Category page view"
          },
          {
            "value": "brand_view",
            "displayValue": "Brand page view"
          },
          {
            "value": "product_hover",
            "displayValue": "Product hovered"
          },
          {
            "value": "custom",
            "displayValue": "Custom event"
          }
        ],
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventInfo",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "LABEL",
            "name": "bootInfo",
            "displayName": "This event must be triggered when the page load to init tracking",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "identifyInfo",
            "displayName": "This event must be triggered when a user log-in to be able to identify him in Reelevant",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "identify",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "pageViewInfo",
            "displayName": "This event can be used to track viewed pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "page_view",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "productPageInfo",
            "displayName": "This event can be used to track viewed product pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_page",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "productHoverInfo",
            "displayName": "This event can be used to track viewed product that are hovered",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_hover",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "addCartInfo",
            "displayName": "This event can be used to track add to cart actions",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "add_cart",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "purchaseInfo",
            "displayName": "This event can be used to track purchases of one or multiple items",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "categoryViewInfo",
            "displayName": "This event can be used to track viewed category pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "category_view",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "brandViewInfo",
            "displayName": "This event can be used to track viewed brand pages",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "brand_view",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "LABEL",
            "name": "customInfo",
            "displayName": "You can trigger any custom event that will be available in Reelevant",
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "custom",
                "type": "EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventConfig",
        "displayName": "Configuration",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "companyId",
            "displayName": "Company\u0027s ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "datasourceId",
            "displayName": "Datasource\u0027s ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "PARAM_TABLE",
            "name": "globalLabels",
            "displayName": "Labels",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "name",
                  "displayName": "Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "boot",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "brandNames",
            "displayName": "Brand name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "brand_view",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "categoryNames",
            "displayName": "Category name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "category_view",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "productIds",
            "displayName": "Product\u0027s ids",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_page",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "add_cart",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "product_hover",
                "type": "EQUALS"
              }
            ],
            "textAsList": true,
            "valueValidators": [
              {
                "type": "TABLE_ROW_COUNT",
                "args": [
                  1
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "totalPrice",
            "displayName": "Total price",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              }
            ],
            "textAsList": false,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "userId",
            "displayName": "User\u0027s id",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "identify",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "customEventName",
            "displayName": "Event\u0027s name",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "custom",
                "type": "EQUALS"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "transId",
            "displayName": "Transaction ID (optional)",
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              }
            ]
          },
          {
            "type": "PARAM_TABLE",
            "name": "labels",
            "displayName": "Additionals labels",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "name",
                  "displayName": "Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "enablingConditions": [
              {
                "paramName": "eventName",
                "paramValue": "product_page",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "add_cart",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "purchase",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "custom",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "page_view",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "category_view",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "brand_view",
                "type": "EQUALS"
              },
              {
                "paramName": "eventName",
                "paramValue": "product_hover",
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');

// Utils
function transformLabels (rawLabels) {
  return rawLabels.reduce((labels, label) => {
    labels[label.name] = label.value;
    return labels;
  }, {});
}
function objectAssign (obj1, obj2, obj3, obj4) {
  const result = {};
  for (const key in obj1) {
    result[key] = obj1[key];
  }
  for (const key in obj2) {
    result[key] = obj2[key];
  }
  if (!obj3) obj3 = {};
  for (const key in obj3) {
    result[key] = obj3[key];
  }
  if (!obj4) obj4 = {};
  for (const key in obj4) {
    result[key] = obj4[key];
  }
  return result;
}

// Global config
const eventName = data.eventName;
const labels = transformLabels(data.labels || []);

function onScriptLoaded () {
  log('Reelevant script injected!');
  data.gtmOnSuccess();
}
function onScriptFailure () {
  log('Injecting reelevant script failed');
  data.gtmOnFailure();
}

function main () {
  // Inject script and save global labels
  if (eventName === 'boot') {
      log('Injecting reelevant script');
      // Config script
      const datasourceId = data.datasourceId;
      const companyId = data.companyId;
      const queue = copyFromWindow('reel.queue');
      setInWindow('reel', {
        datasourceId: datasourceId,
        companyId: companyId,
        queue: queue || [],
        globalLabels: transformLabels(data.globalLabels || [])
      }, true);
      injectScript('https://scripts-repo.reelevant.com/rlvt?company=' + companyId + '&datasource=' + datasourceId, onScriptLoaded, onScriptFailure);
      return;
  }
  log('Reelevant, triggering:', eventName);
  
  // Add queue only if reel doesn't exists yet
  setInWindow('reel', {
    queue: []
  }, false);
  
  // Init config / utils for event handling
  const globalLabels = copyFromWindow('reel.globalLabels') || {}; // retrieve labels
  function pushEvent (name, payload) {
    log('Push', name, payload);
    if (name === 'identify') {
      callInWindow('reel.queue.push', ['identify', payload]);
      return;
    }
    callInWindow('reel.queue.push', [name, objectAssign(
      payload, globalLabels, labels
    )]);
  }

  // Handle event
  switch (eventName) {
    case 'page_view': {
      pushEvent('page_view', {});
      break;
    }
    case 'product_page': {
      pushEvent('product_page', {
        ids: data.productIds
      });
      break;
    }
    case 'product_hover': {
      pushEvent('product_hover', {
        ids: data.productIds
      });
      break;
    }
    case 'category_view': {
      pushEvent('category_view', {
        ids: data.categoryNames
      });
      break;
    }
    case 'brand_view': {
      pushEvent('brand_view', {
        ids: data.brandNames
      });
      break;
    }
    case 'add_cart': {
      pushEvent('add_cart', {
        ids: data.productIds
      });
      break;
    }
    case 'purchase': {
      pushEvent('purchase', {
        ids: data.productIds,
        value: data.totalPrice,
        transId: data.transId
      });
      break;
    }
    case 'identify': {
      pushEvent('identify', data.userId);
      break;
    }
    case 'custom': {
      pushEvent(data.customEventName, {});
      break;
    }
  }
  data.gtmOnSuccess();
}
main();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "reel.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "reel"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "reel.globalLabels"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "reel.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://scripts-repo.reelevant.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Add to queue before boot and set global labels
  code: |-
    // Call page view before boot
    runCode({
      eventName: 'page_view'
    });
    assertApi('setInWindow').wasCalledWith('reel', { queue: [] }, false);
    assertApi('callInWindow').wasCalledWith('reel.queue.push', ['page_view', {}]);

    // Mock queue and inject script
    mock('copyFromWindow', [['page_view', {}]]);
    mock('injectScript', function (_, onSuccess) {
      return onSuccess();
    });

    // Call boot
    runCode({
      eventName: 'boot',
      datasourceId: 'foo',
      companyId: 'bar',
      globalLabels: [{ name: 'labelName', value: 'labelValue' }]
    });

    // Verify that the boot finished successfully
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('setInWindow').wasCalledWith('reel', {
      datasourceId: 'foo',
      companyId: 'bar',
      queue: [['page_view', {}]],
      globalLabels: {
        labelName: 'labelValue'
      }
    }, true);


___NOTES___

Created on 22/12/2020 à 16:37:00


